<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>খিদে লাগছে | রাইডার অ্যাপ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Leaflet CSS for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;600;700&display=swap');
        
        /* Fixed Pull-to-refresh and Scroll issues */
        html, body { 
            overscroll-behavior-y: none; /* This stops pull-to-refresh */
            height: 100%;
            overflow: hidden; 
        }

        body { 
            font-family: 'Hind Siliguri', sans-serif; 
            background-color: #f3f4f6; 
            padding-bottom: 80px; 
            -webkit-tap-highlight-color: transparent; 
            overflow-x: hidden; 
            touch-action: manipulation; 
        }
        
        /* Layout Fixes for Map */
        .tab-content { display: none; height: calc(100vh - 140px); overflow-y: auto; position: relative; }
        .active-tab { display: block; }
        #tab-tasks { overflow: hidden; height: calc(100vh - 140px); } /* Map tab shouldn't scroll */
        #home-map { height: 100%; width: 100%; z-index: 1; }

        .nav-active { color: #ef4444; border-top: 3px solid #ef4444; }
        
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #22c55e; }
        input:checked + .slider:before { transform: translateX(24px); }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .animate-spin-custom { animation: spin 1.2s linear infinite; }

        #in-app-notif {
            position: fixed; top: 20px; left: 15px; right: 15px; background: white; border: 2px solid #ef4444;
            border-radius: 25px; padding: 12px 18px; display: flex; align-items: center; gap: 12px;
            z-index: 1000; box-shadow: 0 10px 25px rgba(239, 68, 68, 0.15);
            transform: translateY(-150%); transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); cursor: pointer;
        }
        #in-app-notif.show { transform: translateY(0); }
        
        .bottom-sheet {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; border-top-left-radius: 30px; border-top-right-radius: 30px;
            box-shadow: 0 -10px 25px rgba(0,0,0,0.1); z-index: 40;
            height: 90vh;
            transform: translateY(65vh);
            transition: transform 0.3s ease-out;
            display: flex; flex-direction: column;
        }
        .bottom-sheet.expanded { transform: translateY(10vh); }
        .bottom-sheet.collapsed { transform: translateY(65vh); }
        
        .sheet-header { padding-top: 8px; cursor: grab; touch-action: none; }
        .sheet-handle { width: 40px; height: 5px; background: #e5e7eb; border-radius: 10px; margin: 0 auto 12px; }
        .sheet-content { flex: 1; overflow-y: auto; padding-bottom: 100px; }
        
        .leaflet-marker-icon { transition: all 1s linear; }
        .wallet-card { background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%); color: white; }
        .chat-bubble { max-width: 80%; padding: 10px 15px; border-radius: 20px; margin-bottom: 8px; font-size: 14px; position: relative; }
        .sent { background: #ef4444; color: white; align-self: flex-end; border-bottom-right-radius: 4px; padding-bottom: 20px; }
        .received { background: #f3f4f6; color: #374151; align-self: flex-start; border-bottom-left-radius: 4px; }
        .focus-btn:active { transform: scale(0.9); }

        .msg-status { position: absolute; bottom: 4px; right: 10px; font-size: 10px; color: rgba(255,255,255,0.7); }
        .read-blue { color: #38bdf8 !important; }

        .chat-notif-dot {
            position: absolute; top: -5px; right: -2px; width: 20px; height: 20px;
            background-color: #ef4444; color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: bold; border: 2px solid white;
            animation: pulse 1.5s infinite; z-index: 10;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

        /* Proximity UI Style */
        .proximity-badge { font-size: 9px; font-weight: 800; padding: 2px 8px; border-radius: 8px; text-transform: uppercase; display: flex; align-items: center; gap: 4px; }
        
        /* Initial Loader */
        #main-loader { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body onclick="unlockAudio()">

    <!-- Initial Loader to prevent Auth Screen flickering -->
    <div id="main-loader">
        <div class="text-center">
            <div class="w-12 h-12 border-4 border-red-600 border-t-transparent rounded-full animate-spin-custom mx-auto mb-4"></div>
            <p class="text-gray-500 font-bold">লোড হচ্ছে...</p>
        </div>
    </div>

    <!-- Notification Bar -->
    <div id="in-app-notif" onclick="closeNotification()">
        <div class="notif-icon bg-red-50 w-10 h-10 rounded-full flex items-center justify-center text-red-600"><i class="fas fa-comment-dots"></i></div>
        <div class="flex-1 overflow-hidden">
            <p class="text-[11px] font-bold text-red-600">নোটিফিকেশন</p>
            <p id="notif-text" class="text-sm font-black text-gray-800 truncate">লোড হচ্ছে...</p>
        </div>
    </div>

    <audio id="alert-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto" loop></audio>
    <audio id="chat-sound" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3" preload="auto"></audio>

    <!-- Auth Screen -->
    <div id="auth-screen" class="fixed inset-0 min-h-screen flex items-center justify-center p-6 bg-gray-900 z-[100] hidden">
        <div class="bg-white p-8 rounded-[2.5rem] shadow-2xl w-full max-w-md border-t-8 border-red-600">
            <h2 class="text-3xl font-black text-red-600 text-center mb-2 italic">RIDER APP</h2>
            <p id="auth-subtitle" class="text-center text-gray-400 font-bold text-sm mb-6 uppercase">মোবাইল নম্বর দিয়ে লগইন করুন</p>
            <div id="login-form">
                <input type="number" id="login-phone" placeholder="ফোন নম্বর" class="w-full p-4 mb-4 bg-gray-100 rounded-2xl outline-none text-center font-bold text-lg border-2 border-transparent focus:border-red-500">
                <button onclick="loginRider()" class="w-full bg-red-600 text-white py-4 rounded-2xl font-black text-xl shadow-lg">লগইন করুন</button>
                <p class="text-center mt-4 text-sm font-bold text-gray-500">অ্যাকাউন্ট নেই? <button onclick="toggleAuth('signup')" class="text-red-600 underline">নিবন্ধন করুন</button></p>
            </div>
            <div id="signup-form" class="hidden">
                <input type="text" id="signup-name" placeholder="আপনার নাম" class="w-full p-4 mb-3 bg-gray-100 rounded-2xl outline-none text-center font-bold text-lg border-2 border-transparent focus:border-red-500">
                <input type="number" id="signup-phone" placeholder="ফোন নম্বর" class="w-full p-4 mb-4 bg-gray-100 rounded-2xl outline-none text-center font-bold text-lg border-2 border-transparent focus:border-red-500">
                <button onclick="signupRider()" class="w-full bg-green-600 text-white py-4 rounded-2xl font-black text-xl shadow-lg">নিবন্ধন সম্পন্ন করুন</button>
                <p class="text-center mt-4 text-sm font-bold text-gray-500">অ্যাকাউন্ট আছে? <button onclick="toggleAuth('login')" class="text-red-600 underline">লগইন করুন</button></p>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="app-content" class="hidden">
        <header class="bg-white p-4 sticky top-0 z-[60] shadow-sm flex justify-between items-center border-b">
            <div class="flex items-center gap-3">
                <div class="bg-red-600 w-10 h-10 rounded-full flex items-center justify-center text-white"><i class="fas fa-motorcycle"></i></div>
                <div>
                    <h1 id="rider-name-display" class="text-sm font-black text-gray-800">লোড হচ্ছে...</h1>
                    <div class="flex items-center gap-2">
                        <span id="online-text" class="text-[10px] font-bold text-gray-400">অফলাইন</span>
                        <label class="switch"><input type="checkbox" id="duty-switch" onchange="toggleDuty(this.checked)"><span class="slider"></span></label>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="refreshApp()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-400"><i id="refresh-icon" class="fas fa-sync-alt text-xs"></i></button>
                <div class="text-right">
                    <p class="text-[10px] text-gray-400 font-bold uppercase">আজকের আয়</p>
                    <p id="today-earning" class="text-lg font-black text-green-600">৳ ০</p>
                </div>
            </div>
        </header>

        <!-- Tasks Tab -->
        <section id="tab-tasks" class="tab-content active-tab relative">
            <div id="home-map"></div>
            <button onclick="focusMap()" class="focus-btn absolute top-6 right-6 z-[35] bg-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center text-red-600 border border-gray-100 transition-all">
                <i class="fas fa-crosshairs text-2xl"></i>
            </button>
            <div id="assigned-orders-sheet" class="bottom-sheet hidden">
                <div id="drag-area" class="sheet-header">
                    <div class="sheet-handle"></div>
                    <div class="px-6 flex items-center justify-between mb-2">
                        <h2 class="text-xl font-black text-gray-800">চলমান অর্ডার</h2>
                        <span id="order-badge-code" class="bg-gray-100 px-3 py-1 rounded-full text-[10px] font-black text-gray-500">#00000</span>
                    </div>
                </div>
                <div class="sheet-content px-6" id="active-order-details"></div>
            </div>
            <div id="empty-tasks" class="absolute inset-0 z-[30] bg-gray-50 flex flex-col items-center justify-center text-center p-6">
                <i class="fas fa-box-open text-gray-200 text-6xl mb-4"></i>
                <p class="text-gray-400 font-bold">আপাতত কোন চলমান অর্ডার নেই</p>
            </div>
        </section>

        <!-- History Tab -->
        <section id="tab-history" class="tab-content p-4">
            <h2 class="text-xl font-black mb-1">ডেলিভারি হিস্ট্রি</h2>
            <div id="history-list" class="space-y-3"></div>
        </section>

        <!-- Profile Tab -->
        <section id="tab-profile" class="tab-content p-4">
            
            <div class="bg-white p-6 rounded-[2.5rem] shadow-sm flex items-center gap-4 border mb-6">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center text-red-600 text-2xl"><i class="fas fa-user-tie"></i></div>
                <div>
                    <h3 id="prof-name" class="font-black text-xl">-</h3>
                    <p id="prof-phone" class="text-gray-400 font-bold">-</p>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="bg-white p-5 rounded-[2rem] shadow-sm border text-center">
                    <p class="text-gray-400 font-bold text-[10px] uppercase mb-1">আজকের ডেলিভারি</p>
                    <p id="prof-delivery-count" class="text-2xl font-black text-gray-800">0</p>
                </div>
                <div class="bg-white p-5 rounded-[2rem] shadow-sm border text-center">
                    <p class="text-gray-400 font-bold text-[10px] uppercase mb-1">আজকের মোট আয়</p>
                    <p id="prof-total-earn-top" class="text-2xl font-black text-green-600">৳ ০</p>
                </div>
            </div>

            <div onclick="showWalletDetails()" class="bg-white p-6 rounded-[2.5rem] shadow-sm border flex justify-between items-center mb-4 border-l-[6px] border-l-blue-500 cursor-pointer active:scale-95 transition-transform">
                <div>
                    <p class="text-blue-600 font-black italic text-[11px] mb-1 uppercase tracking-wider">Wallet (Today Cash Collect)</p>
                    <p id="prof-wallet-cash" class="text-3xl font-black text-gray-800">৳ ০</p>
                </div>
                <div class="w-14 h-14 bg-blue-600 rounded-2xl flex items-center justify-center text-white text-2xl shadow-lg shadow-blue-100">
                    <i class="fas fa-wallet"></i>
                </div>
            </div>

            <div onclick="showPaymentDetails()" class="bg-white p-6 rounded-[2.5rem] shadow-sm border flex justify-between items-center mb-6 border-l-[6px] border-l-orange-500 cursor-pointer active:scale-95 transition-transform">
                <div>
                    <p class="text-orange-600 font-black italic text-[11px] mb-1 uppercase tracking-wider">Payment (Today Earned)</p>
                    <p id="prof-payment-earned" class="text-3xl font-black text-gray-800">৳ ০</p>
                </div>
                <div class="w-14 h-14 bg-orange-500 rounded-2xl flex items-center justify-center text-white text-2xl shadow-lg shadow-orange-100">
                    <i class="fas fa-hand-holding-usd"></i>
                </div>
            </div>

            <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border mb-6">
                <h3 class="font-black text-lg mb-4 flex items-center gap-2"><i class="fas fa-tools text-gray-400"></i> ট্রাবলশুট ও সেটিংস</h3>
                <div class="flex justify-between items-center mb-4 pb-4 border-b">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center"><i class="fas fa-volume-up"></i></div>
                        <div>
                            <p class="font-bold text-sm">অ্যাপ সাউন্ড</p>
                            <p class="text-[10px] text-gray-400">অর্ডার সাউন্ড চালু/বন্ধ</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="testSound()" class="text-[10px] font-bold bg-gray-100 px-2 py-1 rounded text-gray-600">টেস্ট</button>
                        <label class="switch"><input type="checkbox" id="sound-switch" onchange="toggleAppSound(this.checked)"><span class="slider"></span></label>
                    </div>
                </div>
                <div class="flex justify-between items-center mb-4 pb-4 border-b">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-purple-50 text-purple-500 flex items-center justify-center"><i class="fas fa-wifi"></i></div>
                        <div>
                            <p class="font-bold text-sm">ইন্টারনেট</p>
                            <p id="status-network-text" class="text-[10px] text-gray-400">চেক করা হচ্ছে...</p>
                        </div>
                    </div>
                    <div id="status-network-icon" class="text-gray-300"><i class="fas fa-circle-notch fa-spin"></i></div>
                </div>
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-orange-50 text-orange-500 flex items-center justify-center"><i class="fas fa-location-arrow"></i></div>
                        <div>
                            <p class="font-bold text-sm">লোকেশন (GPS)</p>
                            <p id="status-gps-text" class="text-[10px] text-gray-400">চেক করা হচ্ছে...</p>
                        </div>
                    </div>
                    <div id="status-gps-icon" class="text-gray-300"><i class="fas fa-circle-notch fa-spin"></i></div>
                </div>
                <button onclick="runDiagnostics()" class="w-full mt-4 bg-gray-100 py-3 rounded-xl font-bold text-xs text-gray-600">পুনরায় চেক করুন</button>
            </div>

            <button onclick="logout()" class="w-full bg-red-50 text-red-600 py-4 rounded-2xl font-black">লগআউট করুন</button>
        </section>

        <!-- Chat Modal -->
        <div id="chat-modal" class="fixed inset-0 bg-white z-[250] hidden flex flex-col">
            <header class="p-4 border-b flex justify-between items-center bg-red-600 text-white">
                <div class="flex items-center gap-3">
                    <button onclick="closeChat()" class="text-xl"><i class="fas fa-arrow-left"></i></button>
                    <div>
                        <h3 id="chat-customer-name" class="font-black text-sm">কাস্টমার চ্যাট</h3>
                        <p class="text-[10px] opacity-80">অনলাইন</p>
                    </div>
                </div>
                <button onclick="closeChat()" class="text-2xl">&times;</button>
            </header>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 flex flex-col"></div>
            <div class="p-4 border-t flex gap-2 items-center">
                <input type="text" id="chat-input" placeholder="কিছু লিখুন..." class="flex-1 bg-gray-100 p-3 rounded-2xl outline-none font-bold">
                <button onclick="sendMessage()" class="w-12 h-12 bg-red-600 text-white rounded-full flex items-center justify-center"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

        <!-- Detail Modal -->
        <div id="detail-modal" class="fixed inset-0 bg-black/60 z-[200] hidden flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-md rounded-[2.5rem] flex flex-col max-h-[80vh]">
                <div class="p-6 border-b flex justify-between items-center"><h3 id="modal-title" class="font-black uppercase">বিবরণ</h3><button onclick="closeModal()" class="text-2xl">&times;</button></div>
                <div id="modal-content" class="flex-1 overflow-y-auto p-4"></div>
                <div class="p-4 bg-gray-50 border-t"><p id="modal-footer-total" class="font-black text-red-600 text-center text-xl"></p></div>
            </div>
        </div>

        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around py-3 shadow-2xl z-[60]">
            <button onclick="switchTab('tasks')" id="nav-tasks" class="flex flex-col items-center nav-active px-6"><i class="fas fa-clipboard-list text-xl"></i><span class="text-[10px] font-bold">Tasks</span></button>
            <button onclick="switchTab('history')" id="nav-history" class="flex flex-col items-center text-gray-300 px-6"><i class="fas fa-history text-xl"></i><span class="text-[10px] font-bold">History</span></button>
            <button onclick="switchTab('profile')" id="nav-profile" class="flex flex-col items-center text-gray-300 px-6"><i class="fas fa-user text-xl"></i><span class="text-[10px] font-bold">Profile</span></button>
        </nav>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD_TytbX1kd4SKQ5uHZfd5XVGwdw0gzUOE",
            authDomain: "feeling-hungry-102a9.firebaseapp.com",
            databaseURL: "https://feeling-hungry-102a9-default-rtdb.firebaseio.com",
            projectId: "feeling-hungry-102a9",
            storageBucket: "feeling-hungry-102a9.firebasestorage.app",
            messagingSenderId: "736201265500",
            appId: "1:736201265500:web:7b7064b314247c02ad7199"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentRider = null, currentRiderId = null;
        let watchId = null;
        let isSoundEnabled = localStorage.getItem('khide_rider_sound') !== 'false';
        let isAudioUnlocked = false;
        let activeChatOrderId = null;
        let allRestaurants = {}; 
        let deliveredOrdersToday = [];
        let isChatOpen = false;
        let activeOrderForProximity = null;
        
        let homeMap = null, riderMarker = null, destMarker = null, resMarker = null;
        let riderSelfListener = null;

        const alertSound = document.getElementById('alert-sound');
        const chatSound = document.getElementById('chat-sound');
        const sheet = document.getElementById('assigned-orders-sheet');
        const dragArea = document.getElementById('drag-area');
        let isDragging = false, startY = 0, currentTranslateY = 65;

        // --- REALTIME PROXIMITY LOGIC ---
        function getDistanceKM(lat1, lon1, lat2, lon2) {
            if (!lat1 || !lon1 || !lat2 || !lon2) return "...";
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return (R * c).toFixed(2);
        }

        function updateProximityUI(riderLat, riderLng) {
            if (!activeOrderForProximity) return;
            
            // Calculate distance to Restaurant
            let resLat = null, resLng = null;
            Object.values(allRestaurants).forEach(r => {
                if(r.name === activeOrderForProximity.restaurantName) { resLat = r.lat; resLng = r.lng; }
            });
            const distToRes = getDistanceKM(riderLat, riderLng, resLat, resLng);
            const distToCust = getDistanceKM(riderLat, riderLng, activeOrderForProximity.lat, activeOrderForProximity.lng);

            const resBadge = document.getElementById('prox-res');
            const custBadge = document.getElementById('prox-cust');

            if (resBadge) resBadge.innerText = distToRes + " KM";
            if (custBadge) custBadge.innerText = distToCust + " KM";
        }

        function getBDDate(ts = Date.now()) { return new Intl.DateTimeFormat('en-GB', { timeZone: 'Asia/Dhaka', year: 'numeric', month: '2-digit', day: '2-digit' }).format(new Date(ts)); }
        function getBDTime(ts = Date.now()) { return new Intl.DateTimeFormat('en-GB', { timeZone: 'Asia/Dhaka', hour: '2-digit', minute: '2-digit', hour12: true }).format(new Date(ts)); }
        function unlockAudio() { if (isAudioUnlocked) return; isAudioUnlocked = true; alertSound.load(); chatSound.load(); }
        function closeNotification() { document.getElementById('in-app-notif').classList.remove('show'); }

        dragArea.addEventListener('touchstart', e => { isDragging = true; startY = e.touches[0].clientY; sheet.style.transition = 'none'; });
        document.addEventListener('touchmove', e => { if (!isDragging) return; const deltaY = e.touches[0].clientY - startY; const deltaVH = (deltaY / window.innerHeight) * 100; let newPos = currentTranslateY + deltaVH; if (newPos < 10) newPos = 10; if (newPos > 75) newPos = 75; sheet.style.transform = `translateY(${newPos}vh)`; });
        document.addEventListener('touchend', e => { if (!isDragging) return; isDragging = false; sheet.style.transition = 'transform 0.3s ease-out'; const endY = e.changedTouches[0].clientY; if (endY < startY - 50) { currentTranslateY = 10; sheet.classList.add('expanded'); } else { currentTranslateY = 65; sheet.classList.remove('expanded'); } sheet.style.transform = `translateY(${currentTranslateY}vh)`; });

        function toggleAuth(type) { if(type === 'signup') { document.getElementById('login-form').classList.add('hidden'); document.getElementById('signup-form').classList.remove('hidden'); } else { document.getElementById('login-form').classList.remove('hidden'); document.getElementById('signup-form').classList.add('hidden'); } }
        
        function loginRider() { 
            const phone = document.getElementById('login-phone').value || localStorage.getItem('khide_rider_phone'); 
            if(!phone) {
                hideMainLoader();
                document.getElementById('auth-screen').classList.remove('hidden');
                return;
            } 
            db.ref('riders').once('value', snap => { 
                let found = false; 
                snap.forEach(child => { if(child.val().phone == phone) { currentRider = { ...child.val(), id: child.key }; currentRiderId = child.key; found = true; } }); 
                if(found) { 
                    localStorage.setItem('khide_rider_phone', phone); 
                    setupRiderApp(); 
                    document.getElementById('auth-screen').classList.add('hidden'); 
                    document.getElementById('app-content').classList.remove('hidden'); 
                    hideMainLoader();
                } else {
                    hideMainLoader();
                    document.getElementById('auth-screen').classList.remove('hidden');
                    if(document.getElementById('login-phone').value) alert("নিবন্ধিত নয়!"); 
                }
            }); 
        }

        function hideMainLoader() { document.getElementById('main-loader').style.display = 'none'; }

        function signupRider() { const name = document.getElementById('signup-name').value, phone = document.getElementById('signup-phone').value; if(!name || !phone) return; db.ref('riders').push({ name, phone, online: false, balance: 0 }).then(() => { alert("সফল! লগইন করুন।"); toggleAuth('login'); }); }
        
        function setupRiderApp() { 
            document.getElementById('rider-name-display').innerText = currentRider.name; 
            document.getElementById('prof-name').innerText = currentRider.name; 
            document.getElementById('prof-phone').innerText = currentRider.phone; 
            document.getElementById('sound-switch').checked = isSoundEnabled;
            db.ref('restaurants').on('value', snap => { allRestaurants = snap.val() || {}; });
            initHomeMap(); loadAssignedOrders(); loadHistory(); runDiagnostics();
        }

        function initHomeMap() { 
            if (homeMap) return; 
            homeMap = L.map('home-map', { zoomControl: false, attributionControl: false }).setView([23.8103, 90.4125], 16); 
            L.tileLayer('https://api.maptiler.com/maps/streets-v2/{z}/{x}/{y}.png?key=cOMWR960XrzMsoEW2ktI', { attribution: '&copy; MapTiler' }).addTo(homeMap); 
            setTimeout(() => homeMap.invalidateSize(), 500);
        }
        
        function focusMap() {
            if (!homeMap) return;
            let markers = [];
            if (riderMarker) markers.push(riderMarker.getLatLng());
            if (destMarker) markers.push(destMarker.getLatLng());
            if (resMarker) markers.push(resMarker.getLatLng());
            if (markers.length > 0) { const group = new L.featureGroup(markers.map(ll => L.marker(ll))); homeMap.fitBounds(group.getBounds().pad(0.3)); }
            else { navigator.geolocation.getCurrentPosition(pos => { homeMap.setView([pos.coords.latitude, pos.coords.longitude], 16); }); }
        }

        function toggleDuty(status) { db.ref(`riders/${currentRiderId}`).update({ online: status }); document.getElementById('online-text').innerText = status ? "অনলাইন" : "অফলাইন"; if (status) startLiveTracking(); else stopLiveTracking(); }
        
        function startLiveTracking() { 
            watchId = navigator.geolocation.watchPosition((pos) => { 
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                db.ref(`riders/${currentRiderId}`).update({ lat: lat, lng: lng }); 
                updateProximityUI(lat, lng);
            }, null, { enableHighAccuracy: true }); 
        }
        
        function stopLiveTracking() { navigator.geolocation.clearWatch(watchId); }

        function loadAssignedOrders() {
            db.ref('orders').on('value', snap => {
                let foundOrder = null; snap.forEach(child => { const o = child.val(); if(o.riderId === currentRiderId && o.status !== 'DELIVERED') foundOrder = {id: child.key, ...o}; });
                const sheet = document.getElementById('assigned-orders-sheet'), empty = document.getElementById('empty-tasks');
                if(foundOrder) {
                    activeOrderForProximity = foundOrder;
                    empty.classList.add('hidden'); sheet.classList.remove('hidden'); renderOrderSheet(foundOrder); updateMapMarkers(foundOrder);
                    if(isSoundEnabled && foundOrder.status === 'ASSIGNED') alertSound.play().catch(e => console.log(e)); 
                    else { alertSound.pause(); alertSound.currentTime = 0; }
                    
                    db.ref(`orders/${foundOrder.id}/chat`).on('value', chatSnap => {
                        let unreadCount = 0;
                        chatSnap.forEach(msgSnap => {
                            if(msgSnap.val().sender === 'customer' && msgSnap.val().read === false) unreadCount++;
                        });
                        const badge = document.getElementById(`chat-badge-${foundOrder.id}`);
                        if (badge) {
                            if (unreadCount > 0 && !isChatOpen) { badge.innerText = unreadCount; badge.classList.remove('hidden'); } 
                            else { badge.classList.add('hidden'); }
                        }
                    });

                } else { 
                    activeOrderForProximity = null;
                    empty.classList.remove('hidden'); sheet.classList.add('hidden'); clearMarkers(); alertSound.pause(); alertSound.currentTime = 0; 
                }
            });
        }

        function renderOrderSheet(o) {
            let actionBtn = '';
            if(o.status === 'ASSIGNED') actionBtn = `<button onclick="updateStatus('${o.id}','ACCEPTED')" class="w-full bg-green-600 text-white py-4 rounded-2xl font-black">অর্ডার একসেপ্ট</button>`;
            else if(o.status === 'ACCEPTED') actionBtn = `<button onclick="updateStatus('${o.id}','PICKED_UP')" class="w-full bg-orange-500 text-white py-4 rounded-2xl font-black">পিকআপ সম্পন্ন</button>`;
            else if(o.status === 'PICKED_UP') actionBtn = `<button onclick="updateStatus('${o.id}','ARRIVED')" class="w-full bg-blue-500 text-white py-4 rounded-2xl font-black">লোকেশন পৌঁছেছি</button>`;
            else if(o.status === 'ARRIVED') actionBtn = `<button onclick="updateStatus('${o.id}','DELIVERED')" class="w-full bg-red-600 text-white py-4 rounded-2xl font-black">ডেলিভারি সম্পন্ন</button>`;

            let resPhone = ''; Object.values(allRestaurants).forEach(r => { if(r.name === o.restaurantName) resPhone = r.phone; });
            let itemSubtotal = 0; if(o.items) { Object.values(o.items).forEach(item => { itemSubtotal += (item.qty || 1) * (item.price || 0); }); }
            let tip = (o.total || 0) - itemSubtotal - (parseFloat(o.deliveryCharge) || 0); if(tip < 0) tip = 0;

            document.getElementById('order-badge-code').innerText = "#" + o.id.slice(-5);
            document.getElementById('active-order-details').innerHTML = `
                <div class="grid grid-cols-3 gap-2 mb-3">
                    <div class="bg-red-50 p-2 rounded-2xl border border-red-100 text-center"><p class="text-[9px] font-black text-red-400 uppercase">ডেলিভারি</p><p class="text-base font-black">৳${o.deliveryCharge || 0}</p></div>
                    <div class="bg-pink-50 p-2 rounded-2xl border border-pink-100 text-center"><p class="text-[9px] font-black text-pink-500 uppercase"><i class="fas fa-heart"></i> টিপস</p><p class="text-base font-black text-pink-600">৳${tip}</p></div>
                    <div class="bg-green-50 p-2 rounded-2xl border border-green-100 text-center"><p class="text-[9px] font-black text-green-400 uppercase">মোট বিল</p><p class="text-base font-black text-green-700">৳${o.total || 0}</p></div>
                </div>
                <div class="bg-orange-50 p-4 rounded-2xl border border-orange-100 flex items-center gap-4 mb-3">
                    <div class="w-10 h-10 bg-orange-500 text-white rounded-full flex items-center justify-center flex-shrink-0"><i class="fas fa-utensils"></i></div>
                    <div class="flex-1">
                        <p class="text-[10px] font-black text-orange-400 uppercase flex justify-between">রেস্টুরেন্ট <span id="prox-res" class="proximity-badge bg-orange-200 text-orange-700">... KM</span></p>
                        <div class="flex items-center justify-between"><p class="font-black text-gray-800">${o.restaurantName}</p>
                        ${resPhone ? `<a href="tel:${resPhone}" class="w-8 h-8 bg-white rounded-full flex items-center justify-center text-orange-500 shadow-sm border border-orange-100 ml-auto"><i class="fas fa-phone-alt text-xs"></i></a>` : ''}</div>
                    </div>
                </div>
                <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100 flex gap-4 mb-3">
                    <div class="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center flex-shrink-0"><i class="fas fa-house-user"></i></div>
                    <div class="flex-1">
                        <p class="text-[10px] font-black text-blue-400 flex justify-between">কাস্টমার <span id="prox-cust" class="proximity-badge bg-blue-200 text-blue-700">... KM</span></p>
                        <p class="text-xs font-bold text-gray-700">${o.customerAddress || o.address || 'ঠিকানা পাওয়া যায়নি'}</p>
                    </div>
                </div>
                <div class="flex gap-2 mb-4">
                    <a href="tel:${o.customerPhone}" class="flex-1 bg-green-100 text-green-600 py-3 rounded-xl text-center"><i class="fas fa-phone-alt"></i></a>
                    <button onclick="openChat('${o.id}', '${o.customerName}')" class="flex-1 bg-red-100 text-red-600 py-3 rounded-xl relative">
                        <i class="fas fa-comment-dots"></i> চ্যাট
                        <span id="chat-badge-${o.id}" class="chat-notif-dot hidden">0</span>
                    </button>
                    <button onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${o.lat},${o.lng}')" class="flex-1 bg-orange-100 text-orange-600 py-3 rounded-xl"><i class="fas fa-directions"></i> ম্যাপ</button>
                    <button onclick="showOrderItems('${o.id}')" class="flex-1 bg-blue-100 text-blue-600 py-3 rounded-xl font-bold text-xs">আইটেম</button>
                </div>
                ${actionBtn}
            `;
            // Trigger an immediate proximity check if possible
            navigator.geolocation.getCurrentPosition(p => updateProximityUI(p.coords.latitude, p.coords.longitude));
        }

        function updateMapMarkers(o) {
            const icons = {
                rider: L.divIcon({ html: '<div class="w-8 h-8 bg-red-600 rounded-full border-2 border-white flex items-center justify-center text-white"><i class="fas fa-motorcycle text-xs"></i></div>', iconSize: [32, 32], className:'' }),
                cust: L.divIcon({ html: '<div class="w-8 h-8 bg-blue-600 rounded-full border-2 border-white flex items-center justify-center text-white"><i class="fas fa-user text-xs"></i></div>', iconSize: [32, 32], className:'' }),
                res: L.divIcon({ html: '<div class="w-8 h-8 bg-orange-500 rounded-full border-2 border-white flex items-center justify-center text-white"><i class="fas fa-utensils text-xs"></i></div>', iconSize: [32, 32], className:'' })
            };
            if(o.lat && o.lng) { if(destMarker) destMarker.setLatLng([o.lat, o.lng]); else destMarker = L.marker([o.lat, o.lng], {icon: icons.cust}).addTo(homeMap); }
            db.ref('restaurants').once('value', s => { s.forEach(r => { if(r.val().name === o.restaurantName && r.val().lat) { 
                const pos = [r.val().lat, r.val().lng]; if(resMarker) resMarker.setLatLng(pos); else resMarker = L.marker(pos, {icon: icons.res}).addTo(homeMap); 
            }});});
            if(riderSelfListener) riderSelfListener.off();
            riderSelfListener = db.ref(`riders/${currentRiderId}`);
            riderSelfListener.on('value', snap => { const r = snap.val(); if(r && r.lat) { const pos = [r.lat, r.lng]; if(riderMarker) riderMarker.setLatLng(pos); else riderMarker = L.marker(pos, {icon: icons.rider}).addTo(homeMap); } });
        }

        function clearMarkers() { if(riderMarker) homeMap.removeLayer(riderMarker); if(destMarker) homeMap.removeLayer(destMarker); if(resMarker) homeMap.removeLayer(resMarker); riderMarker = destMarker = resMarker = null; }

        function updateStatus(id, s) { 
            alertSound.pause(); 
            db.ref(`orders/${id}`).update({ status: s, timestamp: firebase.database.ServerValue.TIMESTAMP });
            if(s === 'DELIVERED') { db.ref(`orders/${id}`).once('value', snap => { let earn = (parseFloat(snap.val().deliveryCharge)||0); db.ref(`riders/${currentRiderId}/balance`).transaction(bal => (bal || 0) + earn); }); }
        }

        function openChat(orderId, customerName) {
            isChatOpen = true; 
            activeChatOrderId = orderId; 
            document.getElementById('chat-customer-name').innerText = customerName; 
            document.getElementById('chat-modal').classList.remove('hidden');
            const badge = document.getElementById(`chat-badge-${orderId}`);
            if (badge) badge.classList.add('hidden');
            const box = document.getElementById('chat-messages'); 
            db.ref(`orders/${orderId}/chat`).on('value', snap => {
                box.innerHTML = "";
                let updates = {};
                snap.forEach(child => {
                    const msg = child.val(); const msgId = child.key; const type = msg.sender === 'rider' ? 'sent' : 'received';
                    if(type === 'received' && msg.read === false) { updates[`orders/${orderId}/chat/${msgId}/read`] = true; }
                    let ticks = ''; if(type === 'sent') { if(msg.read) ticks = '<i class="fas fa-check-double read-blue"></i>'; else ticks = '<i class="fas fa-check"></i>'; }
                    box.innerHTML += `<div class="chat-bubble ${type}">${msg.text}${type === 'sent' ? `<span class="msg-status">${ticks}</span>` : ''}</div>`;
                });
                if(Object.keys(updates).length > 0) db.ref().update(updates);
                box.scrollTop = box.scrollHeight; 
            });
        }

        function closeChat() { isChatOpen = false; document.getElementById('chat-modal').classList.add('hidden'); if(activeChatOrderId) db.ref(`orders/${activeChatOrderId}/chat`).off(); }

        function sendMessage() {
            const input = document.getElementById('chat-input'); if(!input.value || !activeChatOrderId) return;
            db.ref(`orders/${activeChatOrderId}/chat`).push({ sender: 'rider', text: input.value, timestamp: Date.now(), read: false }); 
            input.value = "";
        }

        function showOrderItems(id) {
            const m = document.getElementById('detail-modal'), c = document.getElementById('modal-content'); m.classList.remove('hidden');
            document.getElementById('modal-title').innerText = "অর্ডার আইটেম";
            db.ref(`orders/${id}`).once('value', snap => {
                const o = snap.val(); c.innerHTML = ""; if(!o || !o.items) return;
                Object.values(o.items).forEach(item => { c.innerHTML += `<div class="flex justify-between p-3 bg-gray-50 rounded-xl mb-2 font-bold"><p>${item.qty || 1}x ${item.name}</p><p>৳${(item.qty || 1) * (item.price || 0)}</p></div>`; });
                document.getElementById('modal-footer-total').innerText = "মোট বিল: ৳" + o.total;
            });
        }

        function loadHistory() {
            db.ref('orders').on('value', snap => {
                const list = document.getElementById('history-list'); list.innerHTML = ""; 
                let today = getBDDate(), todayTotalEarn = 0, todayCashCollect = 0, todayCount = 0;
                deliveredOrdersToday = [];
                snap.forEach(child => { 
                    const o = {id: child.key, ...child.val()}; 
                    if(o.riderId === currentRiderId && o.status === 'DELIVERED' && getBDDate(o.timestamp) === today) {
                        let itemSubtotal = 0; if(o.items) Object.values(o.items).forEach(i => itemSubtotal += (i.qty||1)*(i.price||0));
                        let tip = (o.total || 0) - itemSubtotal - (parseFloat(o.deliveryCharge) || 0); if(tip < 0) tip = 0;
                        o.calculatedTip = tip;
                        let earn = (parseFloat(o.deliveryCharge)||0) + tip; todayTotalEarn += earn; todayCount++;
                        if(o.paymentMethod !== 'Online') todayCashCollect += parseFloat(o.total || 0);
                        deliveredOrdersToday.push(o);
                        list.innerHTML += `<div class="bg-white p-4 rounded-2xl flex justify-between items-center border"><div><p class="font-bold text-sm">${o.restaurantName}</p><p class="text-[9px] text-gray-400">${getBDTime(o.timestamp)}</p></div><p class="font-black text-green-600">৳${earn}</p></div>`;
                    }
                });
                document.getElementById('today-earning').innerText = "৳ " + todayTotalEarn;
                document.getElementById('prof-total-earn-top').innerText = "৳ " + todayTotalEarn;
                document.getElementById('prof-payment-earned').innerText = "৳ " + todayTotalEarn;
                document.getElementById('prof-delivery-count').innerText = todayCount;
                document.getElementById('prof-wallet-cash').innerText = "৳ " + todayCashCollect;
            });
        }

        function showWalletDetails() {
            const m = document.getElementById('detail-modal'), c = document.getElementById('modal-content');
            document.getElementById('modal-title').innerText = "Cash Collection History";
            m.classList.remove('hidden'); c.innerHTML = "";
            let totalCash = 0;
            const cashOrders = deliveredOrdersToday.filter(o => o.paymentMethod !== 'Online');
            if(cashOrders.length === 0) { c.innerHTML = `<p class="text-center text-gray-400 font-bold py-10">আজ কোন ক্যাশ কালেকশন নেই</p>`; } 
            else { cashOrders.forEach(o => { totalCash += parseFloat(o.total || 0); c.innerHTML += `<div class="flex justify-between items-center p-4 bg-blue-50 rounded-2xl mb-3 border border-blue-100"><div><p class="font-black text-gray-800 text-sm">${o.restaurantName}</p><p class="text-[10px] text-blue-500 font-bold">Order: #${o.id.slice(-5)}</p></div><p class="font-black text-lg text-gray-800">৳${o.total || 0}</p></div>`; }); }
            document.getElementById('modal-footer-total').innerText = "Total Cash: ৳" + totalCash;
        }

        function showPaymentDetails() {
            const m = document.getElementById('detail-modal'), c = document.getElementById('modal-content');
            document.getElementById('modal-title').innerText = "Earnings (Charge + Tips)";
            m.classList.remove('hidden'); c.innerHTML = "";
            let totalEarn = 0;
            if(deliveredOrdersToday.length === 0) { c.innerHTML = `<p class="text-center text-gray-400 font-bold py-10">আজ কোন আয় নেই</p>`; } 
            else { deliveredOrdersToday.forEach(o => { let dCharge = parseFloat(o.deliveryCharge) || 0; let tip = parseFloat(o.calculatedTip) || 0; let subTotal = dCharge + tip; totalEarn += subTotal; c.innerHTML += `<div class="p-4 bg-orange-50 rounded-2xl mb-3 border border-orange-100"><div class="flex justify-between items-start mb-2"><div><p class="font-black text-gray-800 text-sm">${o.restaurantName}</p><p class="text-[10px] text-orange-500 font-bold">Order: #${o.id.slice(-5)}</p></div><p class="font-black text-lg text-orange-600">৳${subTotal}</p></div><div class="flex gap-4 border-t border-orange-200 pt-2 mt-1"><p class="text-[10px] font-bold text-gray-500 uppercase">Charge: ৳${dCharge}</p><p class="text-[10px] font-bold text-pink-500 uppercase">Tip: ৳${tip}</p></div></div>`; }); }
            document.getElementById('modal-footer-total').innerText = "Total Earned: ৳" + totalEarn;
        }

        function runDiagnostics() {
            const online = navigator.onLine;
            document.getElementById('status-network-text').innerText = online ? "কানেকশন ঠিক আছে" : "ইন্টারনেট নেই!";
            document.getElementById('status-network-icon').innerHTML = online ? '<i class="fas fa-check-circle text-green-500"></i>' : '<i class="fas fa-times-circle text-red-500"></i>';
            navigator.geolocation.getCurrentPosition(() => {
                document.getElementById('status-gps-text').innerText = "অবস্থান পাওয়া গেছে";
                document.getElementById('status-gps-icon').innerHTML = '<i class="fas fa-check-circle text-green-500"></i>';
            }, () => {
                document.getElementById('status-gps-text').innerText = "লোকেশন অফ আছে";
                document.getElementById('status-gps-icon').innerHTML = '<i class="fas fa-times-circle text-red-500"></i>';
            });
        }

        function toggleAppSound(checked) { isSoundEnabled = checked; localStorage.setItem('khide_rider_sound', checked); }
        function testSound() { alertSound.play().then(() => setTimeout(() => alertSound.pause(), 2000)); }
        function switchTab(t) { 
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active-tab')); 
            document.getElementById('tab-' + t).classList.add('active-tab'); 
            document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('nav-active'));
            document.getElementById('nav-' + t).classList.add('nav-active');
            if(t === 'tasks' && homeMap) { setTimeout(() => homeMap.invalidateSize(), 300); }
        }
        function closeModal() { document.getElementById('detail-modal').classList.add('hidden'); }
        function logout() { localStorage.clear(); location.reload(); }
        function refreshApp() { location.reload(); }

        // Initial check for session
        window.onload = function() {
            loginRider();
        };
    </script>
</body>
</html>